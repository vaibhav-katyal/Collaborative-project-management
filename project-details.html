<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">HiveMind - Project Details</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="project-details.css">
    <link rel="stylesheet" href="footer.css">
    <!-- Include Font Awesome for the user icon (fallback for text initials) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* ADDED: Simple loading/error state styling */
        .task-status-modal .modal-content {
            max-width: 450px;
        }

        .form-group-inline {
            display: flex;
            gap: 20px;
        }

        .form-group-inline .form-group {
            flex: 1;
        }

        /* Style for the button inside the task card */
        .task-card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            /* Push button to the right */
            align-items: center;
        }

        .task-card {
            /* UPDATED GRID */
            display: grid;
            grid-template-columns: 1fr 200px 150px;
            /* Adjusted columns */
            gap: 10px;
            align-items: center;
        }

        .navbar {
            padding: 10px 0;
            /* Reduced vertical padding */
        }

        .nav-container {
            align-items: center;
            /* Ensure vertical alignment */
            min-height: 60px;
            /* Set a reasonable min height */
        }

        .loading-state {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #6b7280;
        }

        /* NEW: Styles for the tab content containers */
        .tab-content {
            display: none;
            /* Hide all tab content by default */
            padding-top: 20px;
        }

        .tab-content.active {
            display: block;
            /* Show active tab content */
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="logo">HiveMind</a>
                <div class="nav-links">
                    <a href="index.html">Home</a>
                    <a href="projects.html">Projects</a>
                    <a href="community.html">Community</a>
                    <!-- START: Dynamic Auth Container -->
                    <div class="nav-btns" id="nav-buttons">
                        <!-- This container holds the dynamic Sign In button OR the User Profile dropdown -->
                        <div id="auth-ui-container">
                            <!-- Placeholder for Sign In / Icon & Dropdown -->
                        </div>
                        <!-- Removed the static "Get Started" button here -->
                    </div>
                    <!-- END: Dynamic Auth Container -->
                </div>
            </div>
        </nav>
        <div class="navbar-spacer"></div>
    </header>

    <div class="container main-content">
        <div id="project-details-wrapper">
            <div class="project-header-top">
                <div class="project-header-left">
                    <span class="project-status status-active" id="project-status-badge">Active</span>
                    <span class="project-category" id="project-category-display">Design</span>
                    <span class="project-id" id="project-id-display">Project ID: #2024-001</span>
                </div>
                <div class="project-header-actions">
                    <button class="btn-transparent"><i class="fas fa-envelope"></i> Contact Leader</button>
                    <button class="btn-transparent"><i class="fas fa-share-alt"></i> Share Project</button>
                </div>
            </div>

            <header class="project-header">
                <h1 id="project-name-display">E-commerce Platform Redesign</h1>
                <p id="project-description-display">Complete overhaul of the user interface and user experience...</p>
            </header>

            <div class="project-stats">
                <div class="stat-card">
                    <h3 id="stat-progress">75%</h3>
                    <p>Progress</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-members">8</h3>
                    <p>Team Members</p>
                </div>
                <div class="stat-card">
                    <h3>45</h3>
                    <p>Tasks</p>
                </div>
                <div class="stat-card">
                    <h3 id="stat-deadline">Feb 15</h3>
                    <p>Deadline</p>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 75%;"></div>
            </div>

            <div class="tabs">
                <a href="#" class="tab-item active" data-tab="overview"><i class="fas fa-tachometer-alt"></i>
                    Overview</a>
                <a href="#" class="tab-item" data-tab="team"><i class="fas fa-users"></i> Team</a>
                <a href="#" class="tab-item" data-tab="tasks"><i class="fas fa-tasks"></i> Tasks</a>
                <a href="#" class="tab-item" data-tab="timeline"><i class="fas fa-chart-line"></i> Timeline</a>
                <a href="#" class="tab-item" data-tab="progress"><i class="fas fa-chart-bar"></i> Progress</a>
                <a href="#" class="tab-item" data-tab="files"><i class="fas fa-folder"></i> Files</a>
                <a href="#" class="tab-item" data-tab="updates"><i class="fas fa-rss"></i> Updates</a>
            </div>

            <div class="tab-content-wrapper">

                <div class="tab-content active" id="overview-content">
                    <div class="content-grid">
                        <section>
                            <div class="section-card">
                                <h2>Project Objectives</h2>
                                <ul class="objectives-list">
                                    <li class="objective-item">
                                        <i class="fas fa-check-circle"></i>
                                        <div class="objective-item-content">
                                            <h4>Improve User Experience</h4>
                                            <p>Redesign the interface to be more intuitive and user-friendly, reducing
                                                bounce rates by 30%.</p>
                                        </div>
                                    </li>
                                    <li class="objective-item">
                                        <i class="fas fa-check-circle"></i>
                                        <div class="objective-item-content">
                                            <h4>Increase Conversion Rate</h4>
                                            <p>Optimize the checkout process and product pages to boost sales by 25%.
                                            </p>
                                        </div>
                                    </li>
                                    <li class="objective-item">
                                        <i class="fas fa-check-circle"></i>
                                        <div class="objective-item-content">
                                            <h4>Mobile Optimization</h4>
                                            <p>Ensure seamless experience across all devices with responsive design.</p>
                                        </div>
                                    </li>
                                    <li class="objective-item">
                                        <i class="fas fa-check-circle"></i>
                                        <div class="objective-item-content">
                                            <h4>Performance Enhancement</h4>
                                            <p>Reduce page load times by 40% through optimized code and assets.</p>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <div class="section-card" style="margin-top: 2rem;">
                                <h2>Key Features</h2>
                                <div class="features-grid">
                                    <div class="feature-card">
                                        <span class="feature-status status-done">Done</span>
                                        <h4>Advanced Search</h4>
                                        <p>AI-powered product discovery</p>
                                    </div>
                                    <div class="feature-card">
                                        <span class="feature-status status-progress">In Progress</span>
                                        <h4>Personalized Recommendations</h4>
                                        <p>Machine learning algorithms</p>
                                    </div>
                                    <div class="feature-card">
                                        <span class="feature-status status-done">Done</span>
                                        <h4>One-Click Checkout</h4>
                                        <p>Streamlined purchase process</p>
                                    </div>
                                    <div class="feature-card">
                                        <span class="feature-status status-pending">Pending</span>
                                        <h4>Social Integration</h4>
                                        <p>Share and review products</p>
                                    </div>
                                    <div class="feature-card">
                                        <span class="feature-status status-done">Done</span>
                                        <h4>Wishlist & Favorites</h4>
                                        <p>Save items for later</p>
                                    </div>
                                    <div class="feature-card">
                                        <span class="feature-status status-progress">In Progress</span>
                                        <h4>Live Chat Support</h4>
                                        <p>24/7 customer assistance</p>
                                    </div>
                                </div>
                            </div>

                            <div class="section-card" style="margin-top: 2rem;">
                                <h2>Technology Stack</h2>
                                <div class="tech-stack-grid" id="tech-stack-grid">
                                </div>
                            </div>
                        </section>

                        <aside>
                            <div class="section-card">
                                <h2>Project Summary</h2>
                                <ul class="summary-list">
                                    <li><span>Start Date</span><span id="summary-start-date">Dec 1, 2023</span></li>
                                    <li><span>End Date</span><span id="summary-end-date">Feb 15, 2024</span></li>
                                    <li><span>Duration</span><span id="summary-duration">11 weeks</span></li>
                                    <li><span>Leader</span><span id="summary-leader" class="highlight">Leader
                                            Name</span></li>
                                    <li><span>GitHub</span><a href="#" id="summary-github" target="_blank">Link</a></li>
                                    <li><span>Priority</span><span class="highlight">High</span></li>
                                </ul>
                            </div>

                            <div class="section-card" style="margin-top: 2rem;">
                                <h2>Recent Activity</h2>
                                <ul class="activity-list">
                                    <li class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>Design mockups approved</p>
                                            <span>Sarah Johnson • 2 hours ago</span>
                                        </div>
                                    </li>
                                    <li class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>New task assigned to Mike</p>
                                            <span>Sarah Johnson • 4 hours ago</span>
                                        </div>
                                    </li>
                                    <li class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>Code review completed</p>
                                            <span>Lisa Wang • 6 hours ago</span>
                                        </div>
                                    </li>
                                    <li class="activity-item">
                                        <div class="activity-dot"></div>
                                        <div class="activity-content">
                                            <p>Meeting scheduled for tomorrow</p>
                                            <span>David Smith • 1 day ago</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>

                            <div class="section-card" style="margin-top: 2rem;">
                                <h2>Upcoming Milestones</h2>
                                <ul class="milestone-list">
                                    <li class="milestone-item">
                                        <span>User Testing Phase</span>
                                        <span class="milestone-data-group">
                                            <i class="far fa-calendar-alt"></i> Jan 30, 2025
                                        </span>
                                    </li>
                                    <li class="milestone-item">
                                        <span>Final Design Review</span>
                                        <span class="milestone-data-group">
                                            <i class="far fa-calendar-alt"></i> Feb 05, 2025
                                        </span>
                                    </li>
                                    <li class="milestone-item">
                                        <span>Development Complete</span>
                                        <span class="milestone-data-group">
                                            <i class="far fa-calendar-alt"></i> Feb 10, 2025
                                        </span>
                                    </li>
                                    <li class="milestone-item">
                                        <span>Project Launch</span>
                                        <span class="milestone-data-group">
                                            <i class="far fa-calendar-alt"></i> Feb 15, 2025
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </aside>
                    </div>
                </div>

                <div class="tab-content" id="team-content">
                    <div class="section-card">
                        <h2>Team Members (<span id="team-count">0</span>)</h2>
                        <ul class="activity-list" id="team-members-aside">
                        </ul>
                    </div>
                </div>

                <div class="tab-content" id="tasks-content">
                    <div class="section-card">
                        <div class="card-header-with-button">
                            <h2>Project Tasks</h2>
                            <button class="btn-primary" id="create-task-btn" style="display: none;"><i
                                    class="fas fa-plus"></i> Create Task</button>
                        </div>

                        <div class="tasks-controls">
                            <select id="tasks-filter" class="tasks-filter-select">
                                <option value="all">All Tasks</option>
                                <option value="my">My Tasks</option>
                            </select>
                            <input type="text" id="tasks-search" placeholder="Search tasks..."
                                class="tasks-filter-search">
                        </div>

                        <div id="tasks-list-container">
                            <p class="loading-state" id="no-tasks-message">No tasks have been created for this project
                                yet.</p>
                        </div>
                    </div>
                </div>

                <div id="task-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-btn">&times;</span>
                        <h2>Create New Task</h2>
                        <form id="create-task-form">
                            <div class="form-group">
                                <label for="task-name">Task Name</label>
                                <input type="text" id="task-name" required>
                            </div>
                            <div class="form-group">
                                <label for="task-description">Description</label>
                                <textarea id="task-description" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="task-assigned-to">Assigned To</label>
                                <select id="task-assigned-to" required>
                                </select>
                            </div>
                            <div class="form-group-inline">
                                <div class="form-group">
                                    <label for="task-difficulty">Difficulty</label>
                                    <select id="task-difficulty" required>
                                        <option value="Easy">Easy</option>
                                        <option value="Medium">Medium</option>
                                        <option value="Hard">Hard</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="task-priority">Priority</label>
                                    <select id="task-priority" required>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn-primary">Submit Task</button>
                        </form>
                    </div>
                </div>

                <div id="status-update-modal" class="modal task-status-modal">
                    <div class="modal-content">
                        <span class="close-btn update-close-btn">&times;</span>
                        <h2 id="update-task-name">Update Task Status</h2>
                        <form id="status-update-form">
                            <input type="hidden" id="update-task-id">

                            <div class="form-group">
                                <label for="update-task-progress">Current Progress (%)</label>
                                <input type="number" id="update-task-progress" min="0" max="100" value="0" required>
                            </div>

                            <div class="form-group">
                                <label for="update-task-status">Status</label>
                                <select id="update-task-status" required>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Complete">Complete</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="update-task-notes">Notes/Comment (Optional)</label>
                                <textarea id="update-task-notes" rows="2"></textarea>
                            </div>

                            <hr style="margin: 20px 0; border-color: #e5e7eb;">

                            <h3>Request Time Extension (Optional)</h3>
                            <div class="form-group">
                                <label for="update-task-request">Requested New Due Date</label>
                                <input type="date" id="update-task-request">
                                <small style="color: #6b7280; display: block; margin-top: 5px;">This request will be
                                    visible to the Team Leader.</small>
                            </div>

                            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">Submit
                                Update</button>
                        </form>
                    </div>
                </div>

                <div class="tab-content" id="timeline-content">
                    <div class="section-card">
                        <h2>Project Timeline & Milestones</h2>
                        <p class="loading-state" style="padding: 10px;">A detailed Gantt chart and milestone view will
                            be available here soon.</p>
                    </div>
                </div>

                <div class="tab-content" id="progress-content">
                    <div class="section-card">
                        <h2>Project Progress & Analytics</h2>
                        <p class="loading-state" style="padding: 10px;">Detailed burndown charts and key performance
                            indicators will be displayed here.</p>
                    </div>
                </div>

                <div class="tab-content" id="files-content">
                    <div class="section-card">
                        <h2>Project Files & Documents</h2>
                        <p class="loading-state" style="padding: 10px;">File management and document sharing coming
                            soon.</p>
                    </div>
                </div>

                <div class="tab-content" id="updates-content">
                    <div class="section-card">
                        <h2>Project Updates & Changelog</h2>
                        <p class="loading-state" style="padding: 10px;">Recent project updates and notifications will be
                            listed here.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <div class="footer-brand">
                    <a href="index.html" class="footer-logo">HiveMind</a>
                    <p class="brand-description">
                        Empowering teams to build extraordinary projects together. Showcase your
                        collaboration skills and grow your professional network.
                    </p>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-github"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h4 class="column-title">Product</h4>
                        <ul>
                            <li><a href="#">Features</a></li>
                            <li><a href="#">Teams</a></li>
                            <li><a href="#">Projects</a></li>
                            <li><a href="#">Community</a></li>
                            <li><a href="#">Pricing</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h4 class="column-title">Resources</h4>
                        <ul>
                            <li><a href="#">Documentation</a></li>
                            <li><a href="#">Tutorials</a></li>
                            <li><a href="#">Blog</a></li>
                            <li><a href="#">Help Center</a></li>
                            <li><a href="#">API Reference</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h4 class="column-title">Company</h4>
                        <ul>
                            <li><a href="about.html">About Us</a></li>
                            <li><a href="#">Careers</a></li>
                            <li><a href="#">Press</a></li>
                            <li><a href="#">Contact</a></li>
                            <li><a href="feedback.html">Give Feedback</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="copyright">&copy; 2025 HiveMind. All rights reserved.</p>
                <div class="bottom-links">
                    <a href="#">Terms of Service</a>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const projectsKey = 'hivemindProjects';
        const selectedProjectKey = 'selectedProjectID';
        const loggedInUserKey = 'loggedInUser';
        // NEW: Key for storing all tasks across all projects
        const tasksKey = 'hivemindTasks';

        let currentProject;
        let currentUser;

        // --- Data Management Functions ---

        function getProjectById(id) {
            const projects = JSON.parse(localStorage.getItem(projectsKey) || '[]');
            return projects.find(p => p.id === id);
        }

        // NEW: Get tasks for the current project
        function getProjectTasks(projectId) {
            const allTasks = JSON.parse(localStorage.getItem(tasksKey) || '[]');
            return allTasks.filter(task => task.projectId === projectId);
        }

        // NEW: Save a new task
        function saveTask(task) {
            const allTasks = JSON.parse(localStorage.getItem(tasksKey) || '[]');
            task.id = Date.now().toString(); // Simple ID generation
            task.status = 'Pending';
            task.createdAt = new Date().toISOString();
            allTasks.push(task);
            localStorage.setItem(tasksKey, JSON.stringify(allTasks));
            return task;
        }

        function calculateDuration(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (isNaN(startDate) || isNaN(endDate)) return 'N/A';

            const diffTime = Math.abs(endDate - startDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays >= 7) {
                const weeks = Math.round(diffDays / 7);
                return `${weeks} week${weeks !== 1 ? 's' : ''}`;
            } else {
                return `${diffDays} day${diffDays !== 1 ? 's' : ''}`;
            }
        }

        // --- UI Rendering Functions ---

        function renderTeamMembers(project) {
            const teamMembersList = document.getElementById('team-members-aside');
            teamMembersList.innerHTML = '';
            document.getElementById('team-count').textContent = project.teamMembers.length;

            project.teamMembers.forEach(member => {
                const isLeader = member.role === 'Team Leader';
                const listItem = document.createElement('li');
                listItem.className = 'activity-item';
                listItem.innerHTML = `
                <div class="activity-dot" style="background-color: ${isLeader ? '#6c63ff' : '#059669'};"></div>
                <div class="activity-content">
                    <p>${member.name} - ${member.role}</p>
                    <span>${isLeader ? 'Project Leader' : 'Team Member'}</span>
                </div>
            `;
                teamMembersList.appendChild(listItem);
            });
        }

        function renderTechStack(project) {
            const techStackGrid = document.getElementById('tech-stack-grid');
            techStackGrid.innerHTML = '';

            const techItems = project.techStack;

            const columns = [
                { title: 'Primary', icon: 'fas fa-code', items: techItems.slice(0, Math.ceil(techItems.length / 3)) },
                { title: 'Secondary', icon: 'fas fa-server', items: techItems.slice(Math.ceil(techItems.length / 3), Math.ceil(techItems.length * 2 / 3)) },
                { title: 'Tools/Others', icon: 'fas fa-tools', items: techItems.slice(Math.ceil(techItems.length * 2 / 3)) }
            ];

            columns.forEach(columnData => {
                if (columnData.items.length > 0) {
                    const column = document.createElement('div');
                    column.className = 'tech-column';
                    let ulContent = columnData.items.map(item => `<li><i class="${columnData.icon}"></i> ${item}</li>`).join('');
                    column.innerHTML = `
                    <h4>${columnData.title}</h4>
                    <ul>${ulContent}</ul>
                `;
                    techStackGrid.appendChild(column);
                }
            });
        }

        // NEW: Render the tasks list
        function renderTasks(project, filter = 'all', search = '') {
            const container = document.getElementById('tasks-list-container');
            const noTasksMessage = document.getElementById('no-tasks-message');
            let tasks = getProjectTasks(project.projectID);

            // Apply filters
            if (filter === 'my' && currentUser) {
                tasks = tasks.filter(task => task.assignedTo === currentUser.name);
            }

            if (search) {
                const lowerSearch = search.toLowerCase();
                tasks = tasks.filter(task =>
                    task.taskName.toLowerCase().includes(lowerSearch) ||
                    task.description.toLowerCase().includes(lowerSearch) ||
                    task.assignedTo.toLowerCase().includes(lowerSearch)
                );
            }

            if (tasks.length === 0) {
                container.innerHTML = `<p class="loading-state" id="no-tasks-message" style="padding: 10px;">${filter === 'my' ? 'You have no assigned tasks.' : 'No tasks match your filter/search criteria.'}</p>`;
                return;
            }

            container.innerHTML = ''; // Clear existing tasks

            tasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'task-card';
                taskCard.innerHTML = `
                <div>
                    <div class="task-title">${task.taskName}</div>
                    <div class="task-meta">Assigned to: <strong>${task.assignedTo}</strong> | ${task.description.substring(0, 50)}...</div>
                </div>
                <div>
                    <span class="task-badge badge-priority-${task.priority}">Priority: ${task.priority}</span>
                    <span class="task-badge badge-difficulty-${task.difficulty}">Difficulty: ${task.difficulty}</span>
                </div>
                <div>
                    <span class="task-badge" style="background-color: #bfdbfe; color: #1d4ed8;">Status: ${task.status}</span>
                </div>
            `;
                container.appendChild(taskCard);
            });
        }

        // --- Main Initializers ---

        function loadProjectDetails() {
            const projectId = sessionStorage.getItem(selectedProjectKey);
            currentProject = getProjectById(projectId);
            currentUser = JSON.parse(localStorage.getItem(loggedInUserKey));

            const wrapper = document.getElementById('project-details-wrapper');
            const pageTitle = document.getElementById('page-title');

            if (!currentProject) {
                wrapper.innerHTML = `<div class="loading-state">Project not found. Please go back to the <a href="projects.html">Projects List</a>.</div>`;
                pageTitle.textContent = 'HiveMind - Project Not Found';
                return;
            }

            // Check if current user is the leader
            const isLeader = currentUser && currentProject.teamLeader.email === currentUser.email;

            pageTitle.textContent = 'HiveMind - ' + currentProject.projectName;

            // --- Update Header and Main Info ---
            document.getElementById('project-name-display').textContent = currentProject.projectName;
            document.getElementById('project-description-display').textContent = currentProject.projectDescription;
            document.getElementById('project-category-display').textContent = currentProject.projectCategory;
            document.getElementById('project-id-display').textContent = 'Project ID: ' + currentProject.projectID;

            const statusBadge = document.getElementById('project-status-badge');
            statusBadge.textContent = currentProject.projectStatus === 'active' ? 'Active' : (currentProject.projectStatus === 'open' ? 'Open' : 'Completed');
            statusBadge.className = 'project-status ' + (currentProject.projectStatus === 'completed' ? 'status-completed' : 'status-active');

            // --- Update Stats and Summary (Existing logic) ---
            const progress = Math.min(100, Math.max(0, parseInt(currentProject.projectProgress) || 0));
            document.getElementById('stat-progress').textContent = progress + '%';
            document.getElementById('stat-members').textContent = currentProject.teamMembers.length;
            document.getElementById('stat-deadline').textContent = currentProject.expectedEndDate;
            document.getElementById('progress-fill').style.width = progress + '%';

            document.getElementById('summary-start-date').textContent = currentProject.startDate;
            document.getElementById('summary-end-date').textContent = currentProject.expectedEndDate;
            document.getElementById('summary-duration').textContent = calculateDuration(currentProject.startDate, currentProject.expectedEndDate);
            document.getElementById('summary-leader').textContent = currentProject.teamLeader.name;

            const githubLink = document.getElementById('summary-github');
            if (currentProject.gitHubLink) {
                githubLink.textContent = 'View Repository';
                githubLink.href = currentProject.gitHubLink;
                githubLink.style.display = 'inline';
            } else {
                githubLink.style.display = 'none';
            }

            // Render dynamic content for tabs
            renderTeamMembers(currentProject);
            renderTechStack(currentProject);
            renderTasks(currentProject, 'all', ''); // Initial task render

            // NEW: Show 'Create Task' button if user is the leader
            const createTaskBtn = document.getElementById('create-task-btn');
            if (isLeader) {
                createTaskBtn.style.display = 'block';
                setupTaskModal(currentProject);
            } else {
                // NEW: If not leader, set filter to 'my' by default if logged in
                if (currentUser) {
                    document.getElementById('tasks-filter').value = 'my';
                    renderTasks(currentProject, 'my', '');
                }
            }
        }

        // --- Task Management Logic ---

        function setupTaskModal(project) {
            const modal = document.getElementById('task-modal');
            const btn = document.getElementById('create-task-btn');
            const span = document.getElementsByClassName("close-btn")[0];
            const form = document.getElementById('create-task-form');
            const assignedToSelect = document.getElementById('task-assigned-to');

            // Populate Assigned To dropdown
            assignedToSelect.innerHTML = project.teamMembers.map(member =>
                `<option value="${member.name}">${member.name} (${member.role})</option>`
            ).join('');

            // Open modal
            btn.onclick = function () {
                modal.style.display = "block";
                form.reset();
            }

            // Close modal via X or outside click
            span.onclick = function () {
                modal.style.display = "none";
            }
            window.onclick = function (event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // Handle form submission
            form.onsubmit = function (e) {
                e.preventDefault();

                const newTask = {
                    projectId: project.projectID,
                    taskName: document.getElementById('task-name').value.trim(),
                    description: document.getElementById('task-description').value.trim(),
                    assignedTo: document.getElementById('task-assigned-to').value,
                    difficulty: document.getElementById('task-difficulty').value,
                    priority: document.getElementById('task-priority').value,
                };

                if (newTask.taskName && newTask.description) {
                    saveTask(newTask);
                    alert(`Task "${newTask.taskName}" created successfully!`);
                    modal.style.display = "none";

                    // Re-render tasks to show the new one
                    renderTasks(currentProject, document.getElementById('tasks-filter').value, document.getElementById('tasks-search').value);
                } else {
                    alert('Please fill out all required fields.');
                }
            }
        }

        function setupTaskControls() {
            const filterSelect = document.getElementById('tasks-filter');
            const searchInput = document.getElementById('tasks-search');

            const updateTasksView = () => {
                if (currentProject) {
                    renderTasks(currentProject, filterSelect.value, searchInput.value.trim());
                }
            };

            // Event listeners for filtering and searching
            filterSelect.addEventListener('change', updateTasksView);
            searchInput.addEventListener('input', updateTasksView);
        }


        // --- General Setup ---

        function setupTabs() {
            const tabs = document.querySelectorAll('.tabs .tab-item');
            const contents = document.querySelectorAll('.tab-content-wrapper .tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetTab = this.getAttribute('data-tab');

                    // 1. Remove 'active' class from all tabs and content
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    // 2. Add 'active' class to the clicked tab
                    this.classList.add('active');

                    // 3. Show the corresponding content
                    const contentElement = document.getElementById(targetTab + '-content');
                    if (contentElement) {
                        contentElement.classList.add('active');
                    }
                });
            });
        }

        function setupAuthUI() {
            const user = JSON.parse(localStorage.getItem(loggedInUserKey));
            const navButtons = document.getElementById('nav-buttons');
            const signInLink = document.getElementById('sign-in-link');

            if (user) {
                if (signInLink) signInLink.remove();

                // const signOutButton = document.createElement('button');
                // signOutButton.textContent = 'Sign Out';
                signOutButton.className = 'btn-secondary';
                signOutButton.style.padding = '8px 16px';
                signOutButton.style.borderRadius = '8px';
                signOutButton.style.fontWeight = '600';
                signOutButton.style.color = '#ef4444';
                signOutButton.style.border = '1px solid #ef4444';
                signOutButton.style.cursor = 'pointer';

                const getStartedLink = navButtons.querySelector('.btn-primary');
                navButtons.insertBefore(signOutButton, getStartedLink);

                signOutButton.addEventListener('click', function () {
                    localStorage.removeItem(loggedInUserKey);
                    window.location.href = 'login.html';
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProjectDetails();
            setupTabs();
            setupAuthUI();
            setupTaskControls(); // NEW: Setup task filtering/search
        });
    </script>
    <script src="navbar.js"></script>
</body>

</html>